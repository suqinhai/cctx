// run.js
// ============================================
// ä¸»ç¨‹åºå…¥å£ - è¿è¡Œå›æµ‹å¹¶è¾“å‡ºç»“æœ
// ============================================
//
// ä½¿ç”¨æ–¹æ³•ï¼š
//   node run.js
//
// åŠŸèƒ½ï¼š
// 1. ä»è…¾è®¯è´¢ç»APIè·å–Aè‚¡å†å²æ•°æ®
// 2. ä½¿ç”¨MA+ATRç­–ç•¥è¿›è¡Œå›æµ‹
// 3. è®¡ç®—å¹¶è¾“å‡ºæ”¶ç›Šç‡ã€æœ€å¤§å›æ’¤ç­‰æŒ‡æ ‡
// 4. ç”Ÿæˆå‡€å€¼æ›²çº¿CSVæ–‡ä»¶
//

// ========== å¼•å…¥ä¾èµ–æ¨¡å— ==========
const fs = require("fs");       // Node.js æ–‡ä»¶ç³»ç»Ÿæ¨¡å—ï¼Œç”¨äºå†™å…¥æŠ¥å‘Šæ–‡ä»¶
const path = require("path");   // Node.js è·¯å¾„æ¨¡å—ï¼Œç”¨äºå¤„ç†æ–‡ä»¶è·¯å¾„

// å¼•å…¥è‡ªå®šä¹‰æ¨¡å—
const backtest = require("./engine/backtest");        // å›æµ‹å¼•æ“
const MaAtr = require("./strategies/maAtr");          // MA+ATR ç­–ç•¥
const { getStockHistory } = require("./data/index");  // æ•°æ®è·å–å‡½æ•°

// ========== ä¸»ç¨‹åºï¼ˆä½¿ç”¨ IIFE + async/awaitï¼‰ ==========
// IIFE: Immediately Invoked Function Expressionï¼ˆç«‹å³æ‰§è¡Œå‡½æ•°è¡¨è¾¾å¼ï¼‰
// ç”¨äºåœ¨é¡¶å±‚ä½¿ç”¨ async/await è¯­æ³•
(async () => {
    // ========== é…ç½®åŒºåŸŸ ==========
    // åœ¨è¿™é‡Œä¿®æ”¹è¦å›æµ‹çš„è‚¡ç¥¨å’Œå‚æ•°

    // è‚¡ç¥¨ä»£ç ï¼ˆ6ä½æ•°å­—ï¼‰
    // ä¾‹å¦‚ï¼š'000001'=å¹³å®‰é“¶è¡Œ, '600519'=è´µå·èŒ…å°, '300750'=å®å¾·æ—¶ä»£
    const STOCK_CODE = '000001';

    // å›æµ‹æ•°æ®å¤©æ•°
    // è·å–æœ€è¿‘å¤šå°‘ä¸ªäº¤æ˜“æ—¥çš„æ•°æ®
    const DAYS = 500;

    // ========== ç¬¬ä¸€æ­¥ï¼šè·å–å†å²æ•°æ® ==========
    console.log(`ğŸš€ å¼€å§‹æ‹‰å– [${STOCK_CODE}] æœ€è¿‘ ${DAYS} å¤©æ•°æ®...`);

    // è°ƒç”¨æ•°æ®æ¨¡å—è·å–Kçº¿æ•°æ®
    // è¿™æ˜¯ä¸€ä¸ªå¼‚æ­¥æ“ä½œï¼Œéœ€è¦ç­‰å¾…ç½‘ç»œè¯·æ±‚å®Œæˆ
    const data = await getStockHistory(STOCK_CODE, DAYS);

    // ========== ç¬¬äºŒæ­¥ï¼šæ•°æ®æœ‰æ•ˆæ€§æ£€æŸ¥ ==========
    // å¦‚æœæ•°æ®è·å–å¤±è´¥ï¼ˆç½‘ç»œé”™è¯¯æˆ–è‚¡ç¥¨ä»£ç é”™è¯¯ï¼‰ï¼Œæå‰é€€å‡º
    if (!data || data.length === 0) {
        console.log("âŒ æ•°æ®è·å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–è‚¡ç¥¨ä»£ç ã€‚");
        return;  // é€€å‡ºç¨‹åº
    }

    // æ‰“å°æ•°æ®è·å–æˆåŠŸä¿¡æ¯
    // data[data.length - 1] æ˜¯æœ€æ–°çš„ä¸€æ ¹Kçº¿
    console.log(`âœ… è·å–æˆåŠŸ! æ ·æœ¬æ•°: ${data.length} æ¡ (æœ€æ–°æ—¥æœŸ: ${data[data.length - 1].date})`);

    // ========== ç¬¬ä¸‰æ­¥ï¼šæ‰§è¡Œå›æµ‹ ==========
    // è°ƒç”¨å›æµ‹å¼•æ“ï¼Œä¼ å…¥ï¼šæ•°æ®ã€ç­–ç•¥ç±»ã€é…ç½®å‚æ•°
    //
    // é…ç½®è¯´æ˜ï¼š
    // - initialCash: åˆå§‹èµ„é‡‘ï¼ˆAè‚¡ä¸€æ‰‹100è‚¡ï¼Œè‚¡ä»·é«˜çš„éœ€è¦æ›´å¤šèµ„é‡‘ï¼‰
    // - strategyConfig: ç­–ç•¥å‚æ•°
    //   - fast: å¿«é€Ÿå‡çº¿å‘¨æœŸ
    //   - slow: æ…¢é€Ÿå‡çº¿å‘¨æœŸ
    //   - atrPeriod: ATRå‘¨æœŸ
    //   - atrMultiplier: ATRæ­¢æŸå€æ•°
    //   - riskPct: å•ç¬”é£é™©æ¯”ä¾‹
    const result = backtest(data, MaAtr, {
        initialCash: 100000,  // åˆå§‹èµ„é‡‘10ä¸‡å…ƒ
        strategyConfig: {
            fast: 5,           // 5æ—¥å¿«é€Ÿå‡çº¿ï¼ˆæ¯”é»˜è®¤10æ›´çµæ•ï¼‰
            slow: 20,          // 20æ—¥æ…¢é€Ÿå‡çº¿
            atrPeriod: 14,     // 14æ—¥ATR
            atrMultiplier: 2.5, // æ­¢æŸè·ç¦» = 2.5å€ATR
            riskPct: 0.02      // æ¯ç¬”äº¤æ˜“é£é™©2%ï¼ˆæ¯”é»˜è®¤1%æ›´æ¿€è¿›ï¼‰
        }
    });

    // ========== ç¬¬å››æ­¥ï¼šç”ŸæˆæŠ¥å‘Šæ–‡ä»¶ ==========
    // åˆ›å»º report ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    const reportDir = path.join(__dirname, "report");
    if (!fs.existsSync(reportDir)) {
        fs.mkdirSync(reportDir);
    }

    // ç”Ÿæˆå‡€å€¼æ›²çº¿ CSV æ–‡ä»¶
    // CSV æ ¼å¼ï¼šç¬¬ä¸€è¡Œæ˜¯è¡¨å¤´ï¼Œåç»­æ¯è¡Œæ˜¯ä¸€ä¸ªæ•°æ®ç‚¹
    const navCsv = ["date,nav"];  // CSV è¡¨å¤´

    // éå†å‡€å€¼æ•°ç»„ï¼Œç”Ÿæˆæ¯ä¸€è¡Œæ•°æ®
    result.navs.forEach(n => {
        // toFixed(4) ä¿ç•™4ä½å°æ•°
        navCsv.push(`${n.date},${n.nav.toFixed(4)}`);
    });

    // å†™å…¥æ–‡ä»¶ï¼ˆç”¨æ¢è¡Œç¬¦è¿æ¥æ‰€æœ‰è¡Œï¼‰
    fs.writeFileSync(path.join(reportDir, "nav.csv"), navCsv.join("\n"));

    // ========== ç¬¬äº”æ­¥ï¼šè®¡ç®—ä¸šç»©æŒ‡æ ‡ ==========
    const navs = result.navs;

    // ----- è®¡ç®—æ€»æ”¶ç›Šç‡ -----
    // å…¬å¼ï¼š(æœŸæœ«å‡€å€¼ - æœŸåˆå‡€å€¼) / æœŸåˆå‡€å€¼
    const totalRet = (navs[navs.length - 1].nav - navs[0].nav) / navs[0].nav;

    // ----- è®¡ç®—æœ€å¤§å›æ’¤ (Maximum Drawdown, MDD) -----
    // æœ€å¤§å›æ’¤ = ä»å³°å€¼åˆ°è°·å€¼çš„æœ€å¤§è·Œå¹…
    // ç”¨äºè¡¡é‡ç­–ç•¥çš„æœ€å¤§é£é™©
    let peak = -Infinity;  // å†å²æœ€é«˜å‡€å€¼
    let mdd = 0;           // æœ€å¤§å›æ’¤

    navs.forEach(n => {
        // æ›´æ–°å†å²æœ€é«˜å‡€å€¼
        if (n.nav > peak) {
            peak = n.nav;
        }

        // è®¡ç®—å½“å‰å›æ’¤ï¼ˆä»å³°å€¼ä¸‹è·Œçš„ç™¾åˆ†æ¯”ï¼‰
        const dd = (peak - n.nav) / peak;

        // æ›´æ–°æœ€å¤§å›æ’¤
        if (dd > mdd) {
            mdd = dd;
        }
    });

    // ========== ç¬¬å…­æ­¥ï¼šæ‰“å°å›æµ‹ç»“æœ ==========
    console.log("\n------ å›æµ‹ç»“æœ ------");
    console.log(`æ ‡çš„: ${STOCK_CODE}`);
    console.log(`æ€»æ”¶ç›Šç‡: ${(totalRet * 100).toFixed(2)}%`);  // è½¬æ¢ä¸ºç™¾åˆ†æ¯”
    console.log(`æœ€å¤§å›æ’¤: ${(mdd * 100).toFixed(2)}%`);       // è½¬æ¢ä¸ºç™¾åˆ†æ¯”
    console.log(`å‡€å€¼æ–‡ä»¶: report/nav.csv`);
    console.log("----------------------");
})();
